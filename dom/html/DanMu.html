<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<input id="file" type="file">
<div id="parent">
    <div id="video"></div>
</div>
</body>
<style>
    #video{
        width: 100%;
        height: 100%;
        background: black;
    }
    #parent{
        width: 800px;
        height: 600px;
        margin: 40px auto;
    }
</style>
<script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="/lib/jquery3.6.0.js"></script>
<script>
    function BDanMu(parentDom) {
        this.initFlag = false;
        this.pDom = parentDom;
        this.dom = null;
        this.showDom = null;
        this.timer = null;
        this.danMuChi = [];
        this.channels = [[],[],[],[],[]];
        this.danMuDoms = [];
    }

    BDanMu.prototype.init = function () {
        if (!this.initFlag) {
            let p = $(this.pDom)
            if (p.length < 1) {
                this.log("找不到该元素", this.pDom);
                return ;
            }
            this.pDom = $(this.pDom);
            this.dom = $("<div id=\"bTanMu\"></div>")
            $(this.pDom).append(this.dom);
            $(this.dom).css({
                "font-min-size": "18px",
                "color": "whitesmoke",
                "background": "transparent",
                "height": "100%",
                "width": "100%",
                "overflow": "hidden",
                "position": "relative",
                "top": "-100%"
            });
            this.log("add", this.dom, "to", this.pDom);
            for (let cIdx in this.channels) {
                let pY = this.getChannelTop(cIdx);
                this.danMuDoms.push([]);
                for (let i = 0; i < 8; i++) {
                    let dom = this.createNewTanMuDom(pY);
                    $(dom).attr("super", cIdx);
                    $(dom).on("transitionend", this.onDanMuEnd(this));
                    this.danMuDoms[cIdx].push(dom);
                }
            }
            this.log("轨道弹幕复用池初始化", this.danMuDoms);
            this.initFlag = true;
        }
    }

    BDanMu.prototype.addXmlToDanMuChi = function (dom) {
        let data = $(dom).find("d")
        for (let d of data) {
            let dd = $(d).attr("p").split(",");
            this.danMuChi.push(this.newDanMu(dd[0],d.innerText))
        }
        this.danMuChi.sort();
        this.log("当前弹幕池", this.danMuChi)
    }

    BDanMu.prototype.newDanMu = function (time, value, size, color) {
        return {
            time: time,
            value: value,
            size: size,
            color: color
        };
    }

    BDanMu.prototype.selector = function (tanMuChi) {
        // 0 获取应该发送的弹幕
        // 1 那个管道可以发射弹幕？
        // 2 该是否存在可复用的dom？
        // 3 发射dom
        // 4 dom运动完
        let tanMuData = tanMuChi.danMuChi[0];
        if (tanMuData === undefined) {
            tanMuChi.stop();
            return null;
        }
        tanMuData = tanMuChi.danMuChi.shift();
        for (let cIdx in tanMuChi.channels) {
            let channel = tanMuChi.channels[cIdx];
            if (channel.length > 0) {
                let lastDanMu = channel[channel.length - 1];
                let distance = tanMuChi.getTranslateX(lastDanMu);
                if (distance > $(lastDanMu).width()) {
                    tanMuChi.channelSend(cIdx, tanMuData);
                    break;
                }
            } else {
                tanMuChi.channelSend(cIdx, tanMuData);
                break;
            }

        }
    }

    BDanMu.prototype.channelSend = function (idx, data) {
        // 通道可用，获取dom
        let dom = null;
        if (this.danMuDoms[idx].length > 0) {
            dom = this.danMuDoms[idx].shift();
        } else {
            dom = this.createNewTanMuDom(this.getChannelTop(idx));
        }
        $(dom).text(data.value);
        $(dom).attr("channel", idx);
        this.channels[idx].push(dom);
        this.sendDanMu(dom);
    }

    BDanMu.prototype.getChannelTop = function (idx) {
        return 10 + 20 * idx + "px";
    }

    BDanMu.prototype.createNewTanMuDom = function (top) {
        let tanMu = $("<i></i>")
        $(this.dom).append(tanMu);
        $(tanMu).css({
            "user-select": "none",
            "white-space": "nowrap",
            "position": "absolute",
            "top": top,
            "left": "100%",
            'transition': 'transform 7s linear',
            'will-change': 'transform'
        })
        return tanMu;
    }

    BDanMu.prototype.getTranslateX = function (dom) {
        return parseFloat(- $(dom).css("transform").substring(7).split(',')[4])
    }

    BDanMu.prototype.sendDanMu = function (dom) {
        let x = - $(this.dom).width() - $(dom).width() - 10 + "px";
        $(dom).css("transform", "translateX("+ x +")");
        let superIdx = $(dom).attr("super");
        if (superIdx === undefined) {
            $(dom).on("transitionend", this.onDanMuEnd(this));
        }
    }

    BDanMu.prototype.onDanMuEnd = function (tanMuchi) {
        return function () {
            let superIdx = $(this).attr("super");
            if (superIdx === undefined) {
                let idx = $(this).attr("channel");
                tanMuchi.channelRemove(tanMuchi.channels[idx], this);
                $(this).remove();
            } else {
                tanMuchi.channelRemove(tanMuchi.channels[superIdx], this);
                // 弹幕要复位
                $(this).css("transform","");
                $(this).css("transition","");
                tanMuchi.danMuDoms[superIdx].push(this)
                let dom = this;
                let timeout = setTimeout(() => {
                    $(dom).css("transition","transform 7s linear");
                    clearTimeout(timeout);
                }, 100)

            }
        }
    }

    BDanMu.prototype.channelRemove = function (channel, dom) {
        for (let i in channel) {
            if (channel[i][0] === dom) {
                channel.splice(i, 1);
                break;
            }
        }
    }

    BDanMu.prototype.sort = function () {
        this.danMuChi.sort((a, b) => {
            return a - b;
        })
    }

    BDanMu.prototype.start = function () {
        if (this.initFlag) {
            if (this.timer === null) {
                this.timer = setInterval(() => {
                    return this.selector(this)
                    }, 100);
            }
        } else {
            this.log("未初始化，无法启动");
        }
    }

    BDanMu.prototype.stop = function () {
        try {
            clearInterval(this.timer);
            this.timer = null;
        } catch (e) {
            this.log(e)
        }
    }

    BDanMu.prototype.log = function (...data) {
        console.log("BTanMu：", data);
    }

    const input = document.getElementById("file")
    const bDanMu = new BDanMu("#parent");
    bDanMu.init();

    input.addEventListener('change', function() {
        if(this.files.length){
            let file = this.files[0];
            let reader = new FileReader();
            reader.onload = function(){
                bDanMu.init();
                bDanMu.addXmlToDanMuChi(this.result)
                bDanMu.start();
                // todo
            };
            reader.readAsText(file);
        }
    }, false);
</script>
</html>
