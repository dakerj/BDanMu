<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<input id="file" type="file">
<div id="parent">
    <div id="video"></div>
</div>
</body>
<style>
    #bTanMu{
        position: relative;
        left: -25%;
    }
    #bTanMu-show{
        position: relative;
        top: -100%;
        overflow: hidden;
    }
    #video{
        width: 100%;
        height: 100%;
        border: black 1px solid;
    }
    #parent{
        width: 800px;
        height: 600px;
        margin: 40px auto;
    }
</style>
<script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="/lib/jquery3.6.0.js"></script>
<script>
    function BDanMu(parentDom) {
        this.initFlag = false;
        this.pDom = parentDom;
        this.dom = null;
        this.showDom = null;
        this.timer = null;
        this.danMuChi = [];
        this.channels = [[],[],[],[],[]];
    }

    BDanMu.prototype.init = function () {
        if (!this.initFlag) {
            let p = $(this.pDom)
            if (p.length < 1) {
                this.log("找不到该元素", this.pDom);
                return ;
            }
            this.pDom = $(this.pDom);
            this.showDom = $("<div id=\"bTanMu-show\"></div>");
            this.dom = $("<div id=\"bTanMu\"></div>")
            $(this.showDom).append(this.dom);
            $(this.pDom).append(this.showDom);

            $(this.showDom).css({
                "height": "100%",
                "width": "100%",
                "overflow": "hidden",
                "position": "relative",
                "top": "-100%"
            });
            // $(this.dom).css({
            //     "height": "100%",
            //     "width": "150%",
            //     "position": "relative",
            //     "left": "-25%"
            // });
            this.log("add", this.dom, "to", this.pDom);
            // for(let cIdx in this.channels) {
            //
            // }
            let tanmu = $("<h1>aaaa</h1>")
            // console.log($(this.showDom).left());
            // let start = $(this.showDom).left
            $(this.showDom).append(tanmu);
            $(tanmu).css({
                "user-select": "none",
                "white-space": "nowrap",
                "position": "absolute",
                "top": "40px",
                "left": "100%",
                'transition-duration': '7s',
                'transition-property': 'transform',
                'will-change': 'transform'
            })
            let o = setTimeout(() => {
                $(tanmu).css("transform", "translateX(-700px)")
                clearTimeout(o)
            },1000)

            this.initFlag = true;
        }
    }

    BDanMu.prototype.addXmlToDanMuChi = function (dom) {
        let data = $(dom).find("d")
        for (let d of data) {
            let dd = $(d).attr("p").split(",");
            this.danMuChi.push(this.newDanMu(dd[0],d.innerText))
        }
        this.log("当前弹幕池", this.danMuChi)
    }

    BDanMu.prototype.newDanMu = function (time, value, size, color) {
        return {
            time: time,
            value: value,
            size: size,
            color: color
        };
    }

    BDanMu.prototype.selector = function () {
        // 从弹幕池中取元素放入管道中

    }

    BDanMu.prototype.start = function () {
        if (this.initFlag) {
            if (this.timer === null) {
                this.timer = setInterval(this.selector, 100);
            }
        } else {
            this.log("未初始化，无法启动");
        }
    }

    BDanMu.prototype.stop = function () {
        try {
            clearInterval(this.timer);
            this.timer = null;
        } catch (e) {
            this.log(e)
        }
    }

    BDanMu.prototype.log = function (...data) {
        console.log("BTanMu：", data);
    }

    const input = document.getElementById("file")
    const bDanMu = new BDanMu("#parent");
    bDanMu.init();

    input.addEventListener('change', function() {
        if(this.files.length){
            let file = this.files[0];
            let reader = new FileReader();
            reader.onload = function(){
                bDanMu.init();
                bDanMu.addXmlToDanMuChi(this.result)
                // todo
            };
            reader.readAsText(file);
        }
    }, false);
</script>
</html>
